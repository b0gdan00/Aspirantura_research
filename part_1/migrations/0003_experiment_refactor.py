# Generated by Django 6.0.1 on 2026-02-13

import django.db.models.deletion
import django.utils.timezone
from django.db import migrations, models


def copy_m2m_frames_to_fk(apps, schema_editor):
    """
    Migrate old M2M (Experement.frames) to new FK (Frame.experiment).

    Expected join table: part_1_experement_frames(experement_id, frame_id)
    """

    # Table names are stable in SQLite even without quoting, but keep it simple.
    join_table = "part_1_experement_frames"
    frame_table = "part_1_frame"

    with schema_editor.connection.cursor() as cursor:
        # If the join table doesn't exist (fresh DB), nothing to do.
        try:
            cursor.execute(f"SELECT experement_id, frame_id FROM {join_table}")
        except Exception:
            return

        rows = cursor.fetchall()

        frame_to_experiment = {}
        for experement_id, frame_id in rows:
            if frame_id in frame_to_experiment and frame_to_experiment[frame_id] != experement_id:
                raise RuntimeError(
                    f"Frame id={frame_id} is linked to multiple experiments "
                    f"({frame_to_experiment[frame_id]}, {experement_id}); can't auto-migrate to FK."
                )
            frame_to_experiment[frame_id] = experement_id

        if not frame_to_experiment:
            return

        cursor.executemany(
            f"UPDATE {frame_table} SET experiment_id = ? WHERE id = ?",
            [(experement_id, frame_id) for frame_id, experement_id in frame_to_experiment.items()],
        )


class Migration(migrations.Migration):

    dependencies = [
        ("part_1", "0002_experement_frames"),
    ]

    operations = [
        # Add/alter columns on existing Experement table first.
        migrations.AddField(
            model_name="experement",
            name="title",
            field=models.CharField(default="Untitled", max_length=200),
        ),
        migrations.AlterField(
            model_name="experement",
            name="description",
            field=models.TextField(blank=True),
        ),
        migrations.AddField(
            model_name="experement",
            name="status",
            field=models.CharField(
                choices=[
                    ("draft", "Draft"),
                    ("ready", "Ready"),
                    ("running", "Running"),
                    ("finished", "Finished"),
                    ("aborted", "Aborted"),
                    ("failed", "Failed"),
                ],
                default="draft",
                max_length=16,
            ),
        ),
        migrations.AddField(
            model_name="experement",
            name="created_at",
            field=models.DateTimeField(default=django.utils.timezone.now, editable=False),
        ),
        migrations.AddField(
            model_name="experement",
            name="updated_at",
            field=models.DateTimeField(default=django.utils.timezone.now),
        ),
        migrations.AddField(
            model_name="experement",
            name="started_at",
            field=models.DateTimeField(blank=True, null=True),
        ),
        migrations.AddField(
            model_name="experement",
            name="ignited_at",
            field=models.DateTimeField(blank=True, null=True),
        ),
        migrations.AddField(
            model_name="experement",
            name="ended_at",
            field=models.DateTimeField(blank=True, null=True),
        ),
        migrations.AddField(
            model_name="experement",
            name="serial_port",
            field=models.CharField(blank=True, default="", max_length=128),
        ),
        migrations.AddField(
            model_name="experement",
            name="baud_rate",
            field=models.PositiveIntegerField(default=115200),
        ),
        migrations.AddIndex(
            model_name="experement",
            index=models.Index(fields=["status", "created_at"], name="part_1_expe_status_f7a9f3_idx"),
        ),
        # Frame: add received_at + FK to experiment.
        migrations.AddField(
            model_name="frame",
            name="received_at",
            field=models.DateTimeField(default=django.utils.timezone.now, editable=False),
        ),
        migrations.AddField(
            model_name="frame",
            name="experiment",
            field=models.ForeignKey(
                blank=True,
                null=True,
                on_delete=django.db.models.deletion.CASCADE,
                related_name="frames",
                to="part_1.experement",
            ),
        ),
        migrations.AddIndex(
            model_name="frame",
            index=models.Index(fields=["experiment", "second"], name="part_1_fram_experim_793b17_idx"),
        ),
        migrations.AlterModelOptions(
            name="frame",
            options={"ordering": ["second", "id"]},
        ),
        migrations.RunPython(copy_m2m_frames_to_fk, migrations.RunPython.noop),
        # Drop old M2M join table (by removing the field).
        migrations.RemoveField(
            model_name="experement",
            name="frames",
        ),
        # State-only rename: keep DB table name as-is (part_1_experement).
        migrations.SeparateDatabaseAndState(
            database_operations=[],
            state_operations=[
                migrations.RenameModel(old_name="Experement", new_name="Experiment"),
                migrations.AlterModelTable(name="Experiment", table="part_1_experement"),
            ],
        ),
    ]

